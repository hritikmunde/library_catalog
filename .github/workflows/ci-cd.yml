# .github/workflows/ci-cd.yml
name: CI / CD

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Build & test
        run: ./mvnw -B -ntp verify

  deploy:
    name: Deploy to Render (API)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' && needs.build.result == 'success'
    environment: render
    concurrency:
      group: render-deploy-master
      cancel-in-progress: true
    steps:
      - name: Check env secrets exist
        env:
          HAS_KEY: ${{ secrets.RENDER_API_KEY != '' }}
          HAS_ID:  ${{ secrets.RENDER_SERVICE_ID != '' }}
        run: |
          [ "$HAS_KEY" = "true" ] || { echo "Missing RENDER_API_KEY in environment 'render'"; exit 1; }
          [ "$HAS_ID"  = "true" ] || { echo "Missing RENDER_SERVICE_ID in environment 'render'"; exit 1; }
          echo "Secrets present."

      - name: Verify Render service via API (GET)
        env:
          API_KEY:   ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          set -e
          [[ "$SERVICE_ID" == srv-* ]] || { echo "SERVICE_ID must look like srv-XXXXXXXX"; exit 1; }
          RESP=$(curl -sS -w "\n%{http_code}" \
            -H "Authorization: Bearer $API_KEY" \
            https://api.render.com/v1/services/$SERVICE_ID)
          STATUS=$(echo "$RESP" | tail -n1)
          BODY=$(echo "$RESP"  | sed '$d')
          echo "GET /services/$SERVICE_ID -> HTTP $STATUS"
          echo "$BODY"
          test "$STATUS" = "200"

      - name: Trigger deploy (POST with no body)
        env:
          API_KEY:   ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          set -e
          RESP=$(curl -sS -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $API_KEY" \
            "https://api.render.com/v1/services/$SERVICE_ID/deploys")
          STATUS=$(echo "$RESP" | tail -n1)
          BODY=$(echo "$RESP" | sed '$d')
          echo "POST /services/$SERVICE_ID/deploys -> HTTP $STATUS"
          echo "$BODY"
          test "$STATUS" = "201"
